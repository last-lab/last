{% extends layout %}
{% block page_body %}

<h1>标注任务</h1>

<style>
    .form-table {
        display: flex;
        flex-direction: column;
    }

    .text {
        float: left;
        width: 50%;
        padding-right: 20px;
    }

    table {
        float: left;
        border-collapse: collapse;
        width: 300px;
    }

    th,
    td {
        padding: 8px;
        text-align: left;
        border: 1px solid #ccc;
    }

    th {
        background-color: #f2f2f2;
    }

    .button {
        width: 80px;
        /* 设置按钮宽度为80px */
        height: 40px;
        padding: 10px;
        font-size: 16px;
    }

</style>


<div class="form-group">
    <label for="file">标注数据集</label>
    <input type="file" id="file" name="file" value="请选择文件">
</div>


<div class="form-group">
    <div>
        <span>标注方式 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
        <div>
            <input type="checkbox" id="judgment" name="annotationType" value="判断标注">
            <label class="checkbox-label" for="judgment">判断标注</label>
        </div>
        <div>
            <input type="checkbox" id="sorting" name="annotationType" value="排序标注">
            <label class="checkbox-label" for="sorting">排序标注</label>
        </div>
        <div>
            <input type="checkbox" id="boundingBox" name="annotationType" value="框选标注">
            <label class="checkbox-label" for="boundingBox">框选标注</label>
        </div>
    </div>
</div>

<div class="form-date">
    <div class="form-group">
        <label for="deadline">截止时间：</label>
        <input type="datetime-local" id="deadline" name="deadline" value="请输入时间">
    </div>
</div>


<div class="form-table">
    <div class="text">
        <span>任务分配：</span>
    </div>
    <table id="assignTable" <thead>
        <tr>
            <th>标注员</th>
            <th>题目数量百分比（%）</th>
            <th>操作</th>
        </tr>
        </thead>
        <tbody>

        </tbody>
    </table>
</div>

<div>
    <label for="labelUserName">标注员：</label>
    <select id="labelUserName">
        <option value="">请选择标注员</option>
    </select>
    <label for="quantity">题目数量百分比：</label>
    <input type="number" id="labelQuantity" value="百分比">
    <button onclick="addAssignRow()">添加</button>
</div>


<div class="form-table">
    <div class="text">
        <span>审核任务分配</span>
    </div>
    <table id="auditTable" <thead>
        <tr>
            <th>审核员</th>
            <th>题目数量百分比（%）</th>
            <th>操作</th>
        </tr>
        </thead>
        <tbody>

        </tbody>
    </table>
</div>

<div>
    <label for="auditUserName">审核员：</label>
    <select id="auditUserName">
        <option value="">请选择审核员</option>
    </select>
    <label for="quantity">题目数量百分比：</label>
    <input type="number" id="auditQuantity" value="百分比">
    <button onclick="addAuditRow()">添加</button>
</div>




<button class="button" type="submit" onclick="submitForm()">提交</button>

<script>

    // 获取下拉框选项值
    async function fetchUserOptions() {
        // 调用 task/user_ge 接口获取标注员列表
        var userList = await getUserList();
        //   var userList = ['标注员A', '标注员B', '标注员C'];

        var dropdown = document.getElementById('labelUserName');
        dropdown.innerHTML = '<option value="">请选择标注员</option>';

        userList.forEach(function (user) {
            var option = document.createElement('option');
            option.value = user;
            option.text = user;
            dropdown.appendChild(option);
        });

        // 这个是审核表
        var dropdown = document.getElementById('auditUserName');
        dropdown.innerHTML = '<option value="">请选择审核员</option>';

        userList.forEach(function (user) {
            var option = document.createElement('option');
            option.value = user;
            option.text = user;
            dropdown.appendChild(option);
        });
    }

    // 添加新行
    function addAssignRow() {
        var table = document.getElementById('assignTable');
        var username = document.getElementById('labelUserName').value;
        var quantity = document.getElementById('labelQuantity').value;

        if (username && quantity) {
            var row = table.insertRow(-1);
            var cell1 = row.insertCell(0);
            var cell2 = row.insertCell(1);
            var cell3 = row.insertCell(2);

            cell1.innerHTML = username;
            cell2.innerHTML = quantity;
            cell3.innerHTML = '<button onclick="deleteRow(this)">删除</button>';

            // 清空输入框
            document.getElementById('labelUserName').value = '';
            document.getElementById('labelQuantity').value = '';
        }
    }


    function addAuditRow() {
        var table = document.getElementById('auditTable');
        var username = document.getElementById('auditUserName').value;
        var quantity = document.getElementById('auditQuantity').value;
        if (username && quantity) {
            var row = table.insertRow(-1);
            var cell1 = row.insertCell(0);
            var cell2 = row.insertCell(1);
            var cell3 = row.insertCell(2);

            cell1.innerHTML = username;
            cell2.innerHTML = quantity;
            cell3.innerHTML = '<button onclick="deleteRow(this)">删除</button>';

            // 清空输入框
            document.getElementById('auditUserName').value = '';
            document.getElementById('auditQuantity').value = '';
        }
    }

    // 删除行
    function deleteRow(btn) {
        var row = btn.parentNode.parentNode;
        row.parentNode.removeChild(row);
    }

    // 页面加载时获取下拉框选项值
    window.onload = function () {
        fetchUserOptions();
    };

    function submitForm() {
        var fileInput = document.getElementById('file');
        var file = fileInput.files[0];
        var reader = new FileReader();
        var fileName = file.name; // 获取文件的路径

        // 读取文件内容
        reader.onload = function (e) {
            var fileContent = e.target.result;
            // 在这里对文件内容进行处理

            var annotationTypes = [];
            var checkboxes = document.getElementsByName('annotationType');
            for (var i = 0; i < checkboxes.length; i++) {
                if (checkboxes[i].checked) {
                    annotationTypes.push(checkboxes[i].value);
                }
            }

            var deadlineInput = document.getElementById('deadline');
            var deadline = deadlineInput.value;
            // 用户标注任务分配表
            var assignTable = document.getElementById('assignTable');
            var taskAssignments = [];
            for (var i = 1; i < assignTable.rows.length; i++) {
                var cells = assignTable.rows[i].cells;
                var annotator = cells[0].textContent;
                var taskCount = cells[1].textContent;
                taskAssignments.push({ annotator: annotator, taskCount: taskCount });
            }
            // 审计任务分配表
            var auditTable = document.getElementById('auditTable');
            var auditAssignments = [];
            for (var i = 1; i < auditTable.rows.length; i++) {
                var cells = auditTable.rows[i].cells;
                var auditor = cells[0].textContent;
                var taskCount = cells[1].textContent;
                auditAssignments.push({ auditor: auditor, taskCount: taskCount });
            }

            var formData = {
                fileName: fileName,
                fileContent: fileContent, // 将文件内容添加到表单数据中
                annotationTypes: annotationTypes,
                deadline: deadline,
                file: file,
                taskAssignments: taskAssignments,
                auditAssignments: auditAssignments,
            };
            console.log(formData);
            // 调用回调函数，将数据传递给它进行处理
            // 使用 $.ajax 发送数据到特定的 URL
            $.ajax({
                type: 'POST',
                url: '/admin/taskmanage/create_task_callback',
                data: JSON.stringify(formData),
                contentType: 'application/json',
                success: function (response) {
                    // 请求成功的处理
                    history.back();
                    location.href = '/admin/taskmanage/list';

                    // alert(success);
                },
                error: function (error) {
                    // 请求失败的处理
                    console.log(error);
                }
            });
        };

        // 以文本格式读取文件内容
        reader.readAsText(file);
    }

    async function getUserList() {
        const rsp = await fetch('/admin/taskmanage/get_user_list', {
            method: 'get',
        })
        return rsp.json();
    }

</script>
</body>

{% endblock %}
