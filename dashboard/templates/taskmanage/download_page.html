{% extends layout %}
{% block page_body %}
<!-- 提供一个标注结果显示，以及下载的按钮 -->
<style>
    .table-responsive {
  overflow: auto; /* 添加滚动条 */
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.5/xlsx.full.min.js"></script>
<div>
    <button id="download">下载Excel</button>
</div>
<div class="card">
    <div class="table-responsive" id="tableContainer">

    </div>
</div>

<script>
    const decodedString = '{{sheet_name_list}}'.replace(/&#39;/g, "'");
    const jsonString = decodedString.replace(/'/g, '"');
    const sheetNameList = JSON.parse(jsonString);
    const downloadBtn = document.getElementById('download');
    sheetNameList.forEach((sheetName)=>{create_table(sheetName)});
    // 状态标识
    downloadBtn.addEventListener('click', async () => {
        // 输入文件名
        const filename = prompt('请输入文件名');
        // 等待下一个点击事件触发选择文件夹
        //选择文件夹
        // 拼接完整路径
        const path = filename + '.xlsx';
        // 生成工作表，使用循环的方式
        const wb = XLSX.utils.book_new();
        sheetNameList.forEach((sheetName) =>{
            const dataTable = document.getElementById(sheetName);
            const ws = XLSX.utils.table_to_sheet(dataTable);
            XLSX.utils.book_append_sheet(wb, ws, sheetName);
            // 用完整路径保存文件
        });
        XLSX.writeFile(wb, path);

    });


    // 创建一个新表
    function create_table(sheetName){
        var tableHtml = '<table class="table card-table table-vcenter text-nowrap datatable" id="' +sheetName + '">' +
            '<thead>' +
            '<tr>' +
            '<th>问题</th>' +
            '<th>答案</th>' +
            '<th>风险等级</th>' +
            '<th>标注者</th>' +
            '<th>风险等级</th>' +
            '<th>审核者</th>' +
            '</tr>' +
            '</thead>' +
            '<tbody>';
        get_label_data(sheetName).then((data) =>{
            for (var i = 0; i < data.length; i++) {
                // {"test": {"风险程度": 2}}
                label_user_dict = data[i]['labeling_result']
                audit_user_dict = data[i]['audit_result']
                let label_user
                let risk_level
                let audit_user
                let audit_risk_level
                if (label_user_dict == null){
                    label_user = null;
                    risk_level = null;
                }else{
                    label_user = label_user_dict;
                    // 删除字符串中的单引号
                    var cleanedStr = label_user_dict.replace(/'/g, '"');
                    // 解析字符串为对象
                    var obj = JSON.parse(cleanedStr);
                    // 获取对象的键
                    label_user = Object.keys(obj)[0];
                    risk_level = obj[label_user]['风险程度'];
                }
                if (audit_user_dict == null){
                    audit_user = null;
                    audit_risk_level = null;
                } else{
                    audit_user = audit_user_dict
                    let cleanedStr = audit_user_dict.replace(/'/g, '"');
                    // 解析字符串为对象
                    let obj = JSON.parse(cleanedStr);
                    // 获取对象的键
                    audit_user = Object.keys(obj)[0];
                    audit_risk_level = obj[label_user]['风险程度'];
                }

                tableHtml += '<tr>' +
                    '<td>' + data[i].question + '</td>' +
                    '<td>' + data[i].answer + '</td>' +
                    '<td>' + risk_level + '</td>' +
                    '<td>' + label_user + '</td>' +
                    '<td>' + audit_risk_level + '</td>' +
                    '<td>' + audit_user + '</td>' +
                    '</tr>';
            }
            tableHtml += '</tbody>' +
                '</table>';

        var tableContainer = document.getElementById('tableContainer');
        var tempDiv = document.createElement('div');
        tempDiv.innerHTML = tableHtml;
        tableContainer.appendChild(tempDiv.firstChild);
        });
    }


    async function get_label_data(sheet_name){
        const rsp = await fetch('/admin/taskmanage/get_label_result', {
            method: 'post',
            body: JSON.stringify({"task_id": '{{task_id}}', "sheet_name": sheet_name}),
            headers: {
                'Content-Type': 'application/json'
            }
        })
        return rsp.json();

    }



</script>
{% endblock %}
