{% extends layout %}
{% block page_body %}
<form id="eval-form">
    <fieldset class="form-fieldset" style="width: 100%; margin-left: 12px; max-width: 800px">
        <div class="mb-3">
            <label class="form-label required">评测方案</label>
            <select required class="form-select" id="eval_plan">
                {% for item in eval_plans %}
                <option value="{{ item.id }}">{{ item.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="mb-3">
            <label class="form-label required">待评测模型（可多选）</label>
            {% include "record/mult_select.html" %}
            <button type="button" class="btn btn-link" data-bs-toggle="modal" data-bs-target="#modelModal">
                添加待评测模型
            </button>
        </div>
        <div class="mb-3">
            <label class="form-label required">自动打分模型（仅可单选）</label>
            <select required class="form-select" id="critic">
                {% for item in model_list %}
                <option value="{{ item.id }}">{{ item.name }}</option>
                {% endfor %}
            </select>
            <button type="button" class="btn btn-link" data-bs-toggle="modal" data-bs-target="#criticModal">
                添加自动打分模型
            </button>
        </div>
        <div class="mb-3 row">
            <label class="form-label required">评判流程Prompt类型</label>
            <div class="col-8 offset-2">
                <div class="card">
                    <div class="table-responsive">
                        <table class="table card-table table-vcenter text-nowrap datatable">
                            <thead>
                            <tr>
                                <th></th>
                                <th>prompt类型</th>
                            </tr>
                            </thead>
                            <tbody id="ds_tbody">
                            <tr>
                                <td>
                                    <input data-id = "1"
                                        class="form-check-input m-0 align-middle checkbox-select-item"
                                        type="radio" name="prompt_radio">
                                </td>
                                <td>违反社会主义核心价值观</td>
                            </tr>
                                <td>
                                    <input data-id = "2"
                                        class="form-check-input m-0 align-middle checkbox-select-item"
                                        type="radio" name="prompt_radio">
                            </td>
                                <td>歧视</td>
                            </tr>
                                <td>
                                    <input data-id = "3"
                                        class="form-check-input m-0 align-middle checkbox-select-item"
                                        type="radio" name="prompt_radio">
                            </td>
                                <td>商业违法违规</td>
                            </tr>
                                <td>
                                    <input data-id = "4"
                                        class="form-check-input m-0 align-middle checkbox-select-item"
                                        type="radio" name="prompt_radio">
                                </td>
                                <td>侵害他人合法权益</td>
                            </tr>
                                <td>
                                    <input data-id = "5"
                                        class="form-check-input m-0 align-middle checkbox-select-item"
                                        type="radio" name="prompt_radio">
                                </td>
                                <td>无法满足特定服务类型的安全需求</td>
                            </tr>
                                <td>
                                    <input data-id = "6"
                                        class="form-check-input m-0 align-middle checkbox-select-item"
                                        type="radio" name="prompt_radio">
                                </td>
                                <td>模型应拒答问题</td>
                            </tr>
                                <td>
                                    <input data-id = "7"
                                        class="form-check-input m-0 align-middle checkbox-select-item"
                                        type="radio" name="prompt_radio">
                                </td>
                                <td>不应该拒答问题</td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div class="form-footer">
            <button type="submit" class="btn btn-primary">提交评测</button>
        </div>
    </fieldset>
</form>

<div class="modal" id="modelModal" tabindex="-1">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Model</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="model-form" method="post">
                    <div class="mb-3">
                        <label class="form-label required">{{ _('Evaluation Model') }}</label>
                        <input required type="text" class="form-control" id="endpoint"
                               placeholder="请输入模型名称或路径"/>
                    </div>
                    <div class="mb-3">
                        <label class="form-label required">Access Key</label>
                        <input required type="text" class="form-control" id="access_key"
                               placeholder="请输入模型 Access Key"/>
                    </div>
                    <div class="mb-3">
                        <label class="form-label required">Secret Key</label>
                        <input required type="text" class="form-control" id="secret_key"
                               placeholder="请输入模型 Secret Key,如果无则填None"/>
                    </div>
                    <div class="form-footer">
                        <a href="#" class="btn btn-link link-secondary" data-bs-dismiss="modal">
                            Cancel
                        </a>
                        <button type="submit" id="form-submit-btn" class="btn btn-primary">
                            {{ _('Create new Model')}}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    // 默认选中第2个prompt按钮
    const secondRadioButton = document.querySelector('input[type="radio"][name="prompt_radio"][data-id="2"]');
    if (secondRadioButton) {
        secondRadioButton.checked = true;
    }
    const handleCreateModel = function () {
        const data = {
            endpoint: $('#endpoint').val(),
            access_key: $('#access_key').val(),
            secret_key: $('#secret_key').val()
        }
        $.ajax({
            url: '/admin/model/model_create',
            method: 'POST',
            data: JSON.stringify(data),
            contentType: 'application/json',
            dataType: 'html',
            success: function (data) {
                alert('模型创建成功')
                $('#modelModal').modal('hide')
                window.location.reload()
            },
            error: function (data) {
                console.log(data)
                alert('创建失败')
            }
        })
    }
    const handleCreateEvaluation = function () {
        // 获取选中的单选按钮的 data-id 值
        const selectedId = document.querySelector('input[type="radio"]:checked').getAttribute('data-id');
        const data = {
            "llm_id": values_id.join(','),
            "plan_id": $('#eval_plan').val(),
            "created_at": new Date().getTime(),
            "llm_name": $('#model').val(),
            "critic_id": $('#critic').val(),
            "prompt_id": selectedId,
        }
        
        $.ajax({
            url: '/admin/evaluation/evaluation_create',
            method: 'POST',
            data: JSON.stringify(data),
            contentType: 'application/json',
            success: function (data) {
                if (data.success) {
                    alert('新建评测成功')
                    // window.location.href = '/admin/record/list'
                } else {
                    alert(data.msg)
                }
            },
            error: function (data) {
                console.log(data)
                alert(data.msg)
            }
        })
    }

    const model_form = document.getElementById('model-form')
    const eval_form = document.getElementById('eval-form')
    // 获取选中的单选按钮的 data-id 值
    const selectedId = document.querySelector('input[type="radio"]:checked').getAttribute('data-id');
    model_form.addEventListener('submit', event => {
        event.preventDefault();
        handleCreateModel(event)
    });

    eval_form.addEventListener('submit', event => {
        event.preventDefault();
        handleCreateEvaluation(event)
    })
</script>

{% endblock %}